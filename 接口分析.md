1. 课程查询
流程：
   在课程进行列表查询页面输入查询条件查询课程信息 当不输入查询条件时输入全部课程信息。 
   输入查询条件查询符合条件的课程信息。 
   约束：本教学机构查询本机构的课程信息。

路径  
/content/course/list?pageNo=2&pageSize=1

请求参数:
课程名称、课程审核状态、课程发布状态、当前页码、每页显示记录数。

参数解释：
课程名称：可以模糊搜索
课程审核状态：未提交、已提交、审核通过、审核未通过
课程发布状态：未发布、已发布、已下线
因为是分页查询所以查询条件中还要包括当前页码、每页显示记录数。

响应结果： 课程id、课程名称、任务数、创建时间、是否付费、审核状态、类型，操作
课程id、课程名称
任务数：该课程所包含的课程计划数，即课程章节数。
创建时间
是否付费：课程包括免费、收费两种。
审核状态
类型：录播、直播。
因为是分页查询所以查询结果中还要包括总记录数、当前页、每页显示记录数。

> 查询结果中的审核状态为数据字典中的代码字段，前端会根据审核状态代码 找到对应的名称显示。

{
"auditStatus": "202002",
"courseName": "",
"publishStatus":""
}

###成功响应结果

{
"items": [
{
"id": 26,
"companyId": 1232141425,
"companyName": null,
"name": "spring cloud实战",
"users": "所有人",
"tags": null,
"mt": "1-3",
"mtName": null,
"st": "1-3-2",
"stName": null,
"grade": "200003",
"teachmode": "201001",
"description": "本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。",
"pic": "https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg",
"createDate": "2019-09-04 09:56:19",
"changeDate": "2021-12-26 22:10:38",
"createPeople": null,
"changePeople": null,
"auditStatus": "202002",
"auditMind": null,
"auditNums": 0,
"auditDate": null,
"auditPeople": null,
"status": 1,
"coursePubId": null,
"coursePubDate": null
}
],
"counts": 23,
"page": 2,
"pageSize": 1
}

2. 课程分类查询 *****

请求参数

响应结果

[
{
"id": "1-1",
"name": "前端开发",
"label": "前端开发",
"parentid": "1",
"isShow": 1,
"orderby": 1,
"isLeaf": 0,
"childrenTreeNodes": [{
"id": "1-1",
"name": "前端开发",
"label": "前端开发",
"parentid": "1",
"isShow": 1,
"orderby": 1,
"isLeaf": 0
}],
},
]

3. 新增课程
流程：
   1.编辑课程基本信息
   2.编辑课程营销信息

提交课程基本信息接口：

请求参数
body: {
teachmode: 授课模式 string 录播 直播
name: 课程名称 string
tags: 课程标签 string
mt: 大分类 string
st: 小分类 string
grade: 课程等级 string
description: 课程介绍 string
users: 适用人群 string
pic: 课程图片 string

课程类型 免费 付费
price: 课程价格 number
original_price: 课程原价 number
咨询QQ
微信号
电话
有效期(天）
}

{ 
   "mt": "", 
   "st": "",
   "name": "",
   "pic": "", 
   "teachmode": "200002", 
   "users": "初级人员", 
   "tags": "", 
   "grade": "204001", 
   "description": "",
   "charge": "201000",
   "price": 0, 
   "originalPrice":0, 
   "qq": "", 
   "wechat": "",
   "phone": "",
   "validDays": 365 
}



响应结果
###响应结果如下
#成功响应结果如下 {
   "id": 109,
   "companyId": 1,
   "companyName": null,
   "name": "测试课程103",
   "users": "初级人员",
   "tags": "",
   "mt": "1-1",
   "mtName": null,
   "st": "1-1-1",
   "stName": null,
   "grade": "204001",
   "teachmode": "200002",
   "description": "",
   "pic": "",
   "createDate": "2022-09-08 07:35:16",
   "changeDate": null,
   "createPeople": null,
   "changePeople": null,
   "auditStatus": "202002",
   "status": 1,
   "coursePubId": null,
   "coursePubDate": null,
   "charge": "201000",
   "price": null,
   "originalPrice":0,
   "qq": "",
   "wechat": "",
   "phone": "",
   "validDays": 365
}

填写课程计划：
   课程大纲 ：章节、小节
   小节：上传视频，直播-进入直播间---进入授课老师编辑

4. 修改课程
响应结果和：新增课程一样


5. 查询课程计划  ****
   课程计划包括课程章节、课程小节
   课程章节包括课程小节
   课程小节包括课程视频

GET /teachplan/22/tree-nodes
请求参数： 传课程id


响应参数：
[
{
"changeDate" : null,
"courseId" : 74,
"cousePubId" : null,
"createDate" : null,
"endTime" : null,
"grade" : "2",
"isPreview" : "0",
"mediaType" : null,
"orderby" : 1,
"parentid" : 112,
"pname" : "第1章基础知识",
"startTime" : null,
"status" : null,
"id" : 113,
"teachPlanTreeNodes" : [
   {
   "changeDate" : null,
   "courseId" : 74,
   "cousePubId" : null,
   "createDate" : null,
   "endTime" : null,
   "grade" : "3",
   "isPreview" : "1",
   "mediaType" : "001002",
   "orderby" : 1,
   "parentid" : 113,
   "pname" : "第1节项目概述",
   "startTime" : null,
   "status" : null,
   "id" : 115,
   "teachPlanTreeNodes" : null,
   "teachplanMedia" : {
   "courseId" : 74,
   "coursePubId" : null,
   "mediaFilename" : "2.avi",
   "mediaId" : 41,
   "teachplanId" : 115,
   "id" : null
   }
}
],
"teachplanMedia" : null
},
]

6. 新增 修改课程计划 同一个接口
新增章节
新增小节
ok

7. 删除课程计划

ok
8. 课程计划排序
ok
上移
下移

9. 师资管理 老师新增 老师修改 老师删除
ok

10. 删除课程：课程的审核状态 为未提交 可以删除
ok
删除课程需要删除课程相关的基本信息、营销信息、课程计划、课程教师信息

提交审核 发布 下架

媒资管理
图片 视频 文件
media_files: 媒资信息表
media_process: 待处理视频表。
media_process_history: 视频处理历史表，记录已经处理成功的视频信息


11. 上传图片 ****
流程：
    1、前端进入上传图片界面
    2、上传图片，请求媒资管理服务。 
    3、媒资管理服务将图片文件存储在MinIO。 
    4、媒资管理记录文件信息到数据库。 
    5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。
请求地址：/media/upload/coursefile 
请求内容：
Content-Type: multipart/form-data; form-data; name="filedata"; filename="具体的文件名称"

响应参数：文件信息

12. 上传视频  比较难 *****
流程：
    1、前端对文件进行分块。 
    2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。
    3、如果分块文件不存在则前端开始上传 
    4、前端请求媒资服务上传分块。
    5、媒资服务将分块上传至MinIO。 
    6、前端将分块上传完毕请求媒资服务合并分块。 
    7、媒资服务判断分块上传完成则请求MinIO合并文件。 
    8、合并完成校验合并后的文件是否完整，如果不完整则删除文件。

13. 处理视频 
断点续传
对需要转码处理的视频系统会自动对其处理，处理后生成视频的URL。
处理视频没有用户界面，完全是后台自动执行。

分布式任务处理
分布式任务调度 
有：jdk提供的 Timer、ScheduledExecutor、Quartz、
本平台用 xxl-job


1、任务调度中心广播作业分片。 
2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。
3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。 
4、执行器启动多线程去处理任务。
5、任务处理完成，上传处理后的视频到MinIO。
6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。

合并分块会调用： 上传文件到数据库 addMediaFilesToDb（）方法 
加入
   查询待处理任务:
      查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试3次。
查询待处理任务
      如何保证查询到的待处理视频记录不重复？

查出了待处理的任务后

开始执行任务

14. 审核媒资


15.绑定媒资  课程计划和媒资的绑定
   课程计划和媒资的绑定
   课程计划和媒资的解绑

先做绑定媒资

课程发布模块共包括三块功能：
1、课程预览
点击预览按钮，进入到课程预览页面，预览课程信息
可以点击课程计划，查看课程计划信息
可以查看视频信息
2、课程审核
自动审核和人工审核
具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。
如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。
如果课程内容没有违规信息且课程内容全面则审核通过。课程审核通过后教学机构发布课程成功。
3、课程发布


课程信息编辑完，就可以发布课程
发布课程--运营商--审核课程--发布课程
学习者---通过网站---搜索课程---选课---支付---学习
15. 课程预览
展示的信息： 课程基本信息，课程营销信息，课程计划，课程媒资信息，课程教师信息

请求参数:
传入课程ID

响应参数:
课程详细信息

/open/content/course/whole/课程id

响应：同课程预览service接口返回数据

/open/media/preview/课程计划id

响应：
{"code":0,"msg":"success","result":"视频的url","successful":true}

16. 课程审核

1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。
2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。
3、当课程状态为已提交时运营平台人员对课程进行审核。
4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。
5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。
6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。
7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“
8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。


--------> 1. 查询课程基本信息，课程营销信息，课程计划等信息，包装为课程预发布信息
--------> 2. 向课程预发布表插入一条记录，如果存在，则更新，审核状态为已提交
--------> 3. 更新课程基本信息表，审核状态为已提交
约束:
1、对已提交审核的课程不允许提交审核。
2、本机构只允许提交本机构的课程。
3、没有上传图片不允许提交审核。
4、没有添加课程计划不允许提交审核。

17. 课程发布

课程发布操作对数据库操作如下：
1、向课程发布表course_publish插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。
2、更新course_base表的课程发布状态为：已发布
3、删除课程预发布表的对应记录。
4、向mq_message消息表插入一条消息，消息类型为：course_publish
约束：
1、课程审核通过方可发布。
2、本机构只允许发布本机构的课程。

消息处理操作：***** 有点难度
1、新增消息表
2、扫描消息表。
3、更新消息表。
4、删除消息表。

课程发布 会生成一个静态文件 --- 上传到miniO


// TODO 测试上传接口

contentApplication 启动不了了
Description:

Field mqMessageService in com.goodstudy.content.service.impl.CoursePublishServiceImpl required a bean of type 'com.goodstudy.messagesdk.service.MqMessageService' that could not be found.

The injection point has the following annotations:
- @org.springframework.beans.factory.annotation.Autowired(required=true)


Action:

Consider defining a bean of type 'com.goodstudy.messagesdk.service.MqMessageService' in your configuration.

2023-04-16 10:58:43,490 WARN [Thread-12][HttpClientBeanHolder.java:108] - [HttpClientBeanHolder] Start destroying common HttpClient
2023-04-16 10:58:43,491 WARN [Thread-12][HttpClientBeanHolder.java:114] - [HttpClientBeanHolder] Destruction of the end

这段日志显示了应用程序启动时的调试信息和错误信息。其中包括以下信息：

应用程序开始于2023年4月16日10:55:48 CST启动，最后于2023年4月16日10:55:56 CST关闭。
在应用程序关闭之前，尝试创建一些bean。
创建bean“com.goodstudy.content.feignclient.MediaServiceClient”时发生了异常。异常的原因是创建bean“org.springframework.transaction.annotation.ProxyTransactionManagementConfiguration”时遇到了错误，找不到名为“org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry”的bean。
应用程序启动时发生了错误，导致无法启动。错误信息是“org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'com.goodstudy.messagesdk.service.MqMessageService' available”，表示找不到名为“com.goodstudy.messagesdk.service.MqMessageService”的bean。
根据日志信息，建议检查以下内容：

确认名为“org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry”的bean是否存在。如果没有，请检查配置文件或代码中是否正确配置了该bean。
确认名为“com.goodstudy.messagesdk.service.MqMessageService”的bean是否存在。如果没有，请检查代码中是否正确配置了该bean，或者是否存在其他错误导致无法创建该bean。


课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。


18. 课程搜索  TODO 代办 有点难度 不太会
当课程发布时请求添加课程接口添加课程信息到索引
当课程下架时请求删除课程接口从索引中删除课程信息


全文检索


课程搜索业务分析:
课程名
一级分类:课程领域方向
二级分类:java  c  等
三级分类: 初级 中级  高级

1、启动elasticsearch、kibana。
2、启动网关、内容管理、搜索服务、nginx。
3、启动xxl-job调度中心。
4、在任务调度中心开始课程发布任务。
5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。
6、经过任务调度将课程信息写入索引。
7、通过门户进入搜索页面，查看课程信息是否展示。













